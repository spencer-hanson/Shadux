# (*) Create configuration file
cat > /etc/NetworkManager/NetworkManager.conf << "EOF"
[main]
plugins=keyfile

[keyfile]
hostname=localhost # Is set properly on boot #
EOF

# (*) Install a script which launches NetworkManager on boot
cat > /etc/rc.d/init.d/network-manager << "EOF"
#!/bin/sh
# Written by Marcel van den Boer

. /lib/lsb/init-functions
[ -r /etc/sysconfig/network ] && . /etc/sysconfig/network

case "$1" in
    start)
        log_info_msg "Starting the Network Manager..."

        # Update the persistent hostname for NM. Without this, NM can reset the
        # hostname during an X11 session, which will cause mayhem... 
        sed "s@^hostname=.*\$@hostname=${HOSTNAME}@g" \
                -i /etc/NetworkManager/NetworkManager.conf

        start_daemon /usr/sbin/NetworkManager
        evaluate_retval
        ;;

    stop)
        log_info_msg "Stopping the Network Manager..."
        killproc /usr/sbin/NetworkManager
        evaluate_retval
        ;;

    restart)
        ${0} stop
        sleep 1
        ${0} start
        ;;

    *)
        echo "Usage: ${0} {start|stop|restart}"
        exit 1
        ;;
esac
EOF
chmod 755 /etc/rc.d/init.d/network-manager

pushd /etc/rc.d

for n in 0 1 2 6; do
    ln -svf ../init.d/network-manager rc${n}.d/K79network-manager
done
for n in 3 4 5; do
    ln -svf ../init.d/network-manager rc${n}.d/S21network-manager
done

popd
